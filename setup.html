@app.route('/setup', methods=['GET', 'POST'])
def setup():
    """ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡"""
    if request.method == 'POST':
        try:
            mobile = request.form.get('mobile')
            increase_pct = float(request.form.get('increase_percentage', 0))
            
            data_store['mobile_number'] = mobile
            data_store['increase_percentage'] = increase_pct
            
            logger.info("="*60)
            logger.info(f"ğŸ“± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ SMS")
            logger.info(f"Ø´Ù…Ø§Ø±Ù‡: {mobile}")
            logger.info(f"Ø¯Ø±ØµØ¯ Ø§ÙØ²Ø§ÛŒØ´: {increase_pct}%")
            logger.info("="*60)
            
            try:
                logger.info("ğŸ”§ Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Selenium...")
                scraper.setup_driver()
                logger.info("âœ… Selenium driver Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯")
                
                logger.info(f"ğŸŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØª: {scraper.base_url}")
                scraper.driver.get(scraper.base_url)
                logger.info(f"âœ… Ø³Ø§ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: {scraper.driver.current_url}")
                
                from selenium.webdriver.common.by import By
                from selenium.webdriver.support.ui import WebDriverWait
                from selenium.webdriver.support import expected_conditions as EC
                from selenium.webdriver.common.keys import Keys
                from selenium.common.exceptions import NoAlertPresentException
                import time
                
                time.sleep(5)
                
                logger.info(f"ğŸ“¸ Title ØµÙØ­Ù‡: {scraper.driver.title}")
                
                # Ø¨Ø³ØªÙ† popup Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
                try:
                    logger.info("ğŸš« ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† popup Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†...")
                    
                    close_selectors = [
                        "//button[contains(@class, 'close')]",
                        "//button[@aria-label='Close']",
                        "//button[contains(@class, 'modal-close')]",
                        "//div[contains(@class, 'modal')]//button",
                        "//button[contains(@onclick, 'close')]"
                    ]
                    
                    popup_closed = False
                    for selector in close_selectors:
                        try:
                            close_btn = WebDriverWait(scraper.driver, 2).until(
                                EC.element_to_be_clickable((By.XPATH, selector))
                            )
                            close_btn.click()
                            logger.info(f"âœ… Popup Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§ selector: {selector}")
                            popup_closed = True
                            time.sleep(1)
                            break
                        except:
                            continue
                    
                    if not popup_closed:
                        logger.info("ğŸ”„ ØªÙ„Ø§Ø´ Ø±ÙˆØ´ Ø¯ÛŒÚ¯Ø±: Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ† Ø§Ø² modal")
                        try:
                            backdrop = scraper.driver.find_element(By.XPATH, "//div[contains(@class, 'modal-backdrop') or contains(@class, 'overlay')]")
                            backdrop.click()
                            logger.info("âœ… Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ backdrop Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯")
                            popup_closed = True
                            time.sleep(1)
                        except:
                            pass
                    
                    if not popup_closed:
                        logger.info("ğŸ”„ ÙØ´Ø±Ø¯Ù† Ú©Ù„ÛŒØ¯ ESC")
                        scraper.driver.find_element(By.TAG_NAME, 'body').send_keys(Keys.ESCAPE)
                        time.sleep(1)
                        logger.info("âœ… ESC ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯")
                        popup_closed = True
                    
                    if popup_closed:
                        logger.info("âœ… Popup Ø¨Ø³ØªÙ‡ Ø´Ø¯")
                    
                except Exception as e:
                    logger.warning(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø³ØªÙ† popup: {e}")
                
                time.sleep(2)
                
                # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† input Ù…ÙˆØ¨Ø§ÛŒÙ„
                mobile_selectors = [
                    "//input[@type='tel']",
                    "//input[@name='mobile']",
                    "//input[@name='phone']",
                    "//input[contains(@placeholder, 'Ù…ÙˆØ¨Ø§ÛŒÙ„')]",
                    "//input[contains(@placeholder, 'Ø´Ù…Ø§Ø±Ù‡')]",
                ]
                
                mobile_input = None
                for idx, selector in enumerate(mobile_selectors):
                    try:
                        logger.info(f"ğŸ” ØªÙ„Ø§Ø´ selector {idx+1}: {selector}")
                        mobile_input = WebDriverWait(scraper.driver, 3).until(
                            EC.presence_of_element_located((By.XPATH, selector))
                        )
                        logger.info(f"âœ… ÙÛŒÙ„Ø¯ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ø¨Ø§ selector: {selector}")
                        break
                    except Exception as e:
                        logger.warning(f"âŒ Selector {idx+1} Ú©Ø§Ø± Ù†Ú©Ø±Ø¯")
                        continue
                
                if mobile_input:
                    mobile_input.clear()
                    mobile_input.send_keys(mobile)
                    logger.info(f"âœ… Ø´Ù…Ø§Ø±Ù‡ {mobile} ÙˆØ§Ø±Ø¯ Ø´Ø¯")
                    
                    time.sleep(2)
                    
                    # Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„
                    submit_selectors = [
                        "//button[@type='submit']",
                        "//button[contains(text(), 'Ø§Ø±Ø³Ø§Ù„')]",
                        "//input[@type='submit']",
                    ]
                    
                    submitted = False
                    
                    # Ø±ÙˆØ´ 1: Ú©Ù„ÛŒÚ© Ø¹Ø§Ø¯ÛŒ
                    for idx, selector in enumerate(submit_selectors):
                        try:
                            logger.info(f"ğŸ” ØªÙ„Ø§Ø´ Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡ {idx+1}: {selector}")
                            submit_btn = WebDriverWait(scraper.driver, 3).until(
                                EC.element_to_be_clickable((By.XPATH, selector))
                            )
                            submit_btn.click()
                            logger.info(f"âœ… Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù„ÛŒÚ© Ø´Ø¯")
                            submitted = True
                            break
                        except Exception as e:
                            logger.warning(f"âŒ Ø¯Ú©Ù…Ù‡ {idx+1} Ú©Ø§Ø± Ù†Ú©Ø±Ø¯: {str(e)[:100]}")
                            continue
                    
                    # Ø±ÙˆØ´ 2: JavaScript click
                    if not submitted:
                        logger.info("ğŸ”„ ØªÙ„Ø§Ø´ Ø¨Ø§ JavaScript click...")
                        try:
                            submit_btn = scraper.driver.find_element(By.XPATH, "//button[@type='submit']")
                            scraper.driver.execute_script("arguments[0].click();", submit_btn)
                            logger.info("âœ… Ø¯Ú©Ù…Ù‡ Ø¨Ø§ JavaScript Ú©Ù„ÛŒÚ© Ø´Ø¯")
                            submitted = True
                        except Exception as e:
                            logger.error(f"âŒ JavaScript click Ù‡Ù… Ú©Ø§Ø± Ù†Ú©Ø±Ø¯: {e}")
                    
                    # Ø±ÙˆØ´ 3: ÙØ´Ø±Ø¯Ù† Enter
                    if not submitted:
                        logger.info("ğŸ”„ ÙØ´Ø±Ø¯Ù† Enter...")
                        try:
                            mobile_input.send_keys(Keys.RETURN)
                            logger.info("âœ… Enter ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯")
                            submitted = True
                        except Exception as e:
                            logger.error(f"âŒ Enter Ù‡Ù… Ú©Ø§Ø± Ù†Ú©Ø±Ø¯: {e}")
                    
                    if submitted:
                        logger.info(f"ğŸ“§ Ú©Ù„ÛŒÚ© submit Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ - Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡...")
                        
                        # ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´
                        time.sleep(3)
                        
                        # Ø¨Ø±Ø±Ø³ÛŒ URL
                        current_url = scraper.driver.current_url
                        logger.info(f"ğŸŒ URL Ø¨Ø¹Ø¯ Ø§Ø² submit: {current_url}")
                        
                        # Ú†Ú© Ú©Ø±Ø¯Ù† alert
                        try:
                            alert = scraper.driver.switch_to.alert
                            alert_text = alert.text
                            logger.info(f"âš ï¸ Alert Ù¾ÛŒØ¯Ø§ Ø´Ø¯: {alert_text}")
                            alert.accept()
                        except NoAlertPresentException:
                            logger.info("â„¹ï¸ Alert ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯")
                        except Exception as e:
                            logger.info(f"â„¹ï¸ Ø¨Ø±Ø±Ø³ÛŒ alert: {str(e)[:50]}")
                        
                        # Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ Ø¯Ø± ØµÙØ­Ù‡
                        try:
                            error_selectors = [
                                "//div[contains(@class, 'error')]",
                                "//div[contains(@class, 'alert-danger')]",
                                "//span[contains(@class, 'error')]",
                                "//p[contains(@class, 'text-danger')]",
                                "//div[contains(@class, 'invalid')]",
                                "//div[contains(@class, 'text-red')]"
                            ]
                            
                            found_error = False
                            for selector in error_selectors:
                                try:
                                    error_elements = scraper.driver.find_elements(By.XPATH, selector)
                                    for elem in error_elements:
                                        if elem.is_displayed() and elem.text.strip():
                                            logger.warning(f"âš ï¸ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¯Ø± ØµÙØ­Ù‡: {elem.text}")
                                            found_error = True
                                except:
                                    continue
                            
                            if not found_error:
                                logger.info("â„¹ï¸ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± ØµÙØ­Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯")
                        except Exception as e:
                            logger.info(f"â„¹ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ error messages: {str(e)[:50]}")
                        
                        # Ú†Ú© Ú©Ø±Ø¯Ù† Ø¢ÛŒØ§ ÙÛŒÙ„Ø¯ Ú©Ø¯ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù‡ØŸ
                        try:
                            code_field_selectors = [
                                "//input[contains(@placeholder, 'Ú©Ø¯')]",
                                "//input[@name='code']",
                                "//input[@name='verification_code']",
                                "//input[contains(@class, 'code')]"
                            ]
                            
                            code_field_found = False
                            for selector in code_field_selectors:
                                try:
                                    code_field = scraper.driver.find_element(By.XPATH, selector)
                                    if code_field.is_displayed():
                                        logger.info(f"âœ…âœ…âœ… ÙÛŒÙ„Ø¯ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¸Ø§Ù‡Ø± Ø´Ø¯ - SMS Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡!")
                                        code_field_found = True
                                        break
                                except:
                                    continue
                            
                            if not code_field_found:
                                logger.warning("âŒ ÙÛŒÙ„Ø¯ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ - Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ SMS Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡!")
                        except Exception as e:
                            logger.warning(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ ÙÛŒÙ„Ø¯ Ú©Ø¯: {e}")
                        
                        # Ø¨Ø±Ø±Ø³ÛŒ ØªÙ…Ø§Ù… input Ù‡Ø§ÛŒ ØµÙØ­Ù‡
                        try:
                            all_inputs = scraper.driver.find_elements(By.XPATH, "//input")
                            logger.info(f"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ input Ù‡Ø§ÛŒ ØµÙØ­Ù‡: {len(all_inputs)}")
                            for i, inp in enumerate(all_inputs[:10]):  # ÙÙ‚Ø· 10 ØªØ§ÛŒ Ø§ÙˆÙ„
                                try:
                                    if inp.is_displayed():
                                        logger.info(f"  Input {i+1}: type={inp.get_attribute('type')}, name={inp.get_attribute('name')}, placeholder={inp.get_attribute('placeholder')}")
                                except:
                                    pass
                        except Exception as e:
                            logger.info(f"Ø®Ø·Ø§ Ø¯Ø± Ù„ÛŒØ³Øª Ú©Ø±Ø¯Ù† inputs: {e}")
                        
                        # HTML ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                        logger.info("ğŸ“„ HTML ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² submit (Ø§ÙˆÙ„ 2000 Ú©Ø§Ø±Ø§Ú©ØªØ±):")
                        logger.info(scraper.driver.page_source[:2000])
                        
                        data_store['sms_requested'] = True
                        time.sleep(2)
                    else:
                        logger.error("âŒ Ù‡ÛŒÚ† Ø±ÙˆØ´ÛŒ Ø¨Ø±Ø§ÛŒ submit Ú©Ø§Ø± Ù†Ú©Ø±Ø¯")
                        logger.info("ğŸ“„ HTML ØµÙØ­Ù‡:")
                        logger.info(scraper.driver.page_source[:1500])
                else:
                    logger.error("âŒ ÙÛŒÙ„Ø¯ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯")
                    logger.info("ğŸ“„ HTML ØµÙØ­Ù‡:")
                    logger.info(scraper.driver.page_source[:1500])
                
            except Exception as e:
                logger.error(f"âŒ Ø®Ø·Ø§ÛŒ Selenium: {e}", exc_info=True)
            
            return redirect(url_for('verify'))
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± setup: {e}", exc_info=True)
            return render_template('setup.html', error=str(e))
    
    return render_template('setup.html')
